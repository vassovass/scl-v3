#!/usr/bin/env python3
"""Generate XLSX from proxy steps data"""
import subprocess, sys, json
from datetime import datetime
from collections import defaultdict
from pathlib import Path

# Install deps
for pkg in ['openpyxl']:
    try: __import__(pkg)
    except: subprocess.check_call([sys.executable, '-m', 'pip', 'install', pkg, '-q'])

from openpyxl import Workbook

DATA = json.loads('''[{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2026-01-06","steps":9357},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2026-01-05","steps":13522},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2026-01-04","steps":17701},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2026-01-03","steps":9142},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2026-01-01","steps":9392},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-31","steps":7440},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-30","steps":17146},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-29","steps":8336},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-14","steps":15407},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-13","steps":7620},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-12","steps":8166},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-11","steps":11641},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-03","steps":10462},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-12-01","steps":17209},{"user_id":"cfb9e8f3-22f5-4e81-b442-7969dcdf1707","display_name":"Big D","for_date":"2025-11-30","steps":12959},{"user_id":"678fb579-d0ab-4365-a712-e837e64f812b","display_name":"Brendan","for_date":"2025-12-11","steps":7774},{"user_id":"678fb579-d0ab-4365-a712-e837e64f812b","display_name":"Brendan","for_date":"2025-12-10","steps":12905},{"user_id":"678fb579-d0ab-4365-a712-e837e64f812b","display_name":"Brendan","for_date":"2025-12-09","steps":12150},{"user_id":"678fb579-d0ab-4365-a712-e837e64f812b","display_name":"Brendan","for_date":"2025-12-04","steps":7647},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-17","steps":15476},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-13","steps":11603},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-12","steps":10384},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-11","steps":17165},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-10","steps":10286},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-09","steps":12331},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-08","steps":11947},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-07","steps":9223},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-06","steps":12019},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-03","steps":8928},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-02","steps":6148},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2026-01-01","steps":10986},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-31","steps":15481},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-30","steps":24701},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-29","steps":32864},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-28","steps":7555},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-27","steps":8852},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-26","steps":6185},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-25","steps":8433},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-24","steps":7172},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-23","steps":4262},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-22","steps":4255},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-21","steps":10294},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-20","steps":22060},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-19","steps":11283},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-18","steps":14624},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-17","steps":12467},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-16","steps":10710},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-14","steps":1406},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-13","steps":6684},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-10","steps":2923},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-08","steps":4852},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-07","steps":6348},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-06","steps":14187},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-05","steps":10327},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-04","steps":10418},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-03","steps":11119},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-02","steps":11336},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-12-01","steps":7793},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-30","steps":3327},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-29","steps":7816},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-28","steps":5466},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-27","steps":3080},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-24","steps":2288},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-23","steps":6271},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-22","steps":4478},{"user_id":"33557247-75ad-4155-b531-869b457ff4be","display_name":"Denesh","for_date":"2025-11-21","steps":4162},{"user_id":"ab236625-1236-4bb6-a3f1-7daa8ef87d7f","display_name":"Jay","for_date":"2025-12-21","steps":769},{"user_id":"ab236625-1236-4bb6-a3f1-7daa8ef87d7f","display_name":"Jay","for_date":"2025-12-08","steps":5095},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2026-01-11","steps":8792},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2026-01-02","steps":7032},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2026-01-01","steps":11292},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-31","steps":9641},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-30","steps":12320},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-29","steps":10921},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-28","steps":19549},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-23","steps":12786},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-14","steps":8776},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-13","steps":14966},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-10","steps":8463},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-08","steps":3580},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-07","steps":9802},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-06","steps":11042},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-05","steps":14116},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-04","steps":9885},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-03","steps":6418},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-12-01","steps":6291},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-30","steps":10946},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-29","steps":12990},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-28","steps":15719},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-27","steps":11181},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-26","steps":7624},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-25","steps":8366},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-24","steps":7655},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-23","steps":8477},{"user_id":"fbf5348d-adea-459c-a247-254b377882bf","display_name":"Kei","for_date":"2025-11-22","steps":10550},{"user_id":"71015735-84cd-4986-b281-bedd8a51119b","display_name":"Mel","for_date":"2025-11-24","steps":3050}]''')

wb = Workbook()

# Sheet 1: Step Data
ws = wb.active
ws.title = "Step Data"
ws.append(["Display Name", "Date", "Steps"])
for r in DATA: ws.append([r['display_name'], r['for_date'], r['steps']])

# Sheet 2: Daily Leaderboard
ws2 = wb.create_sheet("Daily Leaderboard")
ws2.append(["Date", "Rank", "Name", "Steps"])
daily = defaultdict(list)
for r in DATA: daily[r['for_date']].append(r)
for d in sorted(daily.keys(), reverse=True):
    ranked = sorted(daily[d], key=lambda x: x['steps'], reverse=True)
    for i, r in enumerate(ranked, 1): ws2.append([d, i, r['display_name'], r['steps']])

# Sheet 3: Summary
ws3 = wb.create_sheet("Summary")
ws3.append(["Name", "Total Steps", "Days", "Avg/Day", "Best Day", "Best Steps"])
stats = defaultdict(lambda: {'total': 0, 'days': 0, 'best': 0, 'best_date': ''})
for r in DATA:
    s = stats[r['display_name']]
    s['total'] += r['steps']; s['days'] += 1
    if r['steps'] > s['best']: s['best'], s['best_date'] = r['steps'], r['for_date']
for n in sorted(stats.keys()):
    s = stats[n]
    ws3.append([n, s['total'], s['days'], round(s['total']/s['days'], 1), s['best_date'], s['best']])

out = Path(__file__).parent / f"proxy_steps_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
wb.save(out)
print(f"Saved: {out}")
